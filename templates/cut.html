<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>音频截取工具</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/static/layui/css/layui.css" rel="stylesheet" />
    <style>
      #content {
        width: 95%;
        min-width: 800px;
        max-width: 2000px;
        margin: 40px auto 50px;
      }
      .layui-header {
        background: #16b777;
      }
      .section-title {
        font-size: 18px;
        margin: 15px 0;
      }
      #upload {
        display: block;
        margin-bottom: 10px;
        border-style: solid;
        padding: 30px 20px;
      }
      .file-info {
        margin-top: 10px;
        color: #333;
      }
      .time-inputs {
        margin-top: 20px;
      }
      .time-group {
        display: flex;
        align-items: center;
      }
      .time-group input {
        width: 70px;
        text-align: center;
      }
      .time-separator {
        padding: 0 5px;
      }
      .time-help {
        color: #999;
        font-size: 12px;
        line-height: 1.5;
      }
      .layui-form-item {
        margin-bottom: 20px;
      }
      .history-table {
        margin-top: 20px;
      }
      .layui-side {
        width: 200px;
        top: 60px;
        transition: margin-left 0.3s;
      }
      .layui-side.hide {
        margin-left: -200px;
      }
      .layui-body {
        top: 60px;
        padding: 15px;
        transition: left 0.3s;
      }
      .layui-body.sidebar-hidden {
        left: 0 !important;
      }
      .sidebar-toggle {
        position: fixed;
        left: 200px;
        top: 60px;
        z-index: 1000;
        background: #393D49;
        color: #fff;
        border: none;
        padding: 10px 5px;
        cursor: pointer;
        border-radius: 0 4px 4px 0;
        transition: left 0.3s;
      }
      .sidebar-toggle:hover {
        background: #2F3437;
      }
      .sidebar-toggle.sidebar-hidden {
        left: 0;
      }
    </style>
  </head>
  <body>
    <div class="layui-layout layui-layout-admin">
      <div class="layui-header" style="background: #16b777;z-index:1">
        <div class="layui-logo layui-hide-xs" style="color: #fff">音频截取工具</div>
      </div>
      <!-- 侧边栏 -->
      <div class="layui-side layui-bg-black" id="sidebar">
        <div class="layui-side-scroll">
          <ul class="layui-nav layui-nav-tree" lay-filter="nav">
            <li class="layui-nav-item">
              <a href="/" data-cn="语音识别" data-en="Speech Recognition">
                <i class="layui-icon layui-icon-mic"></i> <span class="menu-text"></span>
              </a>
            </li>
            <li class="layui-nav-item layui-nav-itemed">
              <a href="/cut" data-cn="音频截取" data-en="Audio Cut">
                <i class="layui-icon layui-icon-cut"></i> <span class="menu-text"></span>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <!-- 隐藏/显示侧边栏按钮 -->
      <button class="sidebar-toggle" id="sidebar-toggle" title="隐藏/显示菜单">
        <i class="layui-icon layui-icon-shrink-right"></i>
      </button>
      <!-- 内容主体区域 -->
      <div class="layui-body">
        <div id="content">
      <h2>音频截取工具</h2>
      <p>步骤：1）上传音频 2）输入开始/结束时间（格式 00:00:00）3）点击“截取并保存”。</p>

      <!-- 上传区域 -->
      <div class="layui-upload-drag layui-border-green" id="upload">
        <i class="layui-icon layui-icon-upload layui-font-green"></i>
        <div>点击上传，或将音频/视频文件拖拽到此处（mp3/mp4/wav/m4a 等）</div>
        <div id="uploaded-info" class="file-info"></div>
      </div>

      <!-- 预览 -->
      <div id="audio-preview" class="file-info"></div>

      <!-- 时间输入和操作 -->
      <div class="time-inputs">
        <div class="layui-form layui-form-pane">
          <div class="layui-form-item">
            <label class="layui-form-label">开始时间</label>
            <div class="layui-input-inline time-group">
              <input
                type="text"
                id="start-h"
                value="00"
                maxlength="2"
                class="layui-input"
              />
              <span class="time-separator">时</span>
              <input
                type="text"
                id="start-m"
                value="00"
                maxlength="2"
                class="layui-input"
              />
              <span class="time-separator">分</span>
              <input
                type="text"
                id="start-s"
                value="00"
                maxlength="2"
                class="layui-input"
              />
              <span class="time-separator">秒</span>
            </div>
          </div>

          <div class="layui-form-item">
            <div class="layui-input-block">
              <span class="time-help">为空时自动按 00 处理，例如 00时01分30秒</span>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">结束时间</label>
            <div class="layui-input-inline time-group">
              <input
                type="text"
                id="end-h"
                value="00"
                maxlength="2"
                class="layui-input"
              />
              <span class="time-separator">时</span>
              <input
                type="text"
                id="end-m"
                value="00"
                maxlength="2"
                class="layui-input"
              />
              <span class="time-separator">分</span>
              <input
                type="text"
                id="end-s"
                value="00"
                maxlength="2"
                class="layui-input"
              />
              <span class="time-separator">秒</span>
            </div>
          </div>

          <div class="layui-form-item">
            <div class="layui-input-block">
              <span class="time-help">必须大于开始时间</span>
            </div>
          </div>

          <div class="layui-form-item">
            <button
              type="button"
              class="layui-btn layui-btn-danger"
              id="cut-btn"
            >
              截取并保存
            </button>
          </div>
        </div>
      </div>

      <!-- 截取结果 -->
      <div id="cut-result" class="file-info"></div>

      <!-- 历史记录 -->
      <div class="history-table">
        <div class="section-title">历史截取记录</div>
        <table class="layui-table" id="history-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>文件名</th>
              <th>截取时间段</th>
              <th>截取时长</th>
              <th>大小 (MB)</th>
              <th>操作时间</th>
              <th>下载</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script src="/static/layui/layui.js"></script>
    <script>
      let language = "zh"; // 强制使用中文
      window.$ = layui.$;
      
      // 强制显示中文
      $("[data-cn]").each(function () {
        var $this = $(this);
        var text = $this.attr("data-cn");
        // 如果是菜单项，填充到 .menu-text 中
        var $menuText = $this.find(".menu-text");
        if ($menuText.length) {
          $menuText.text(text);
        } else {
          // 其他元素，追加文字
          $this.html($this.html() + text);
        }
      });
      
      layui.use(["upload", "layer", "element"], function () {
        var upload = layui.upload;
        var layer = layui.layer;
        var $ = layui.$;
        var element = layui.element;
        
        // 侧边栏隐藏/显示功能
        var sidebarHidden = false;
        $("#sidebar-toggle").click(function() {
          sidebarHidden = !sidebarHidden;
          if (sidebarHidden) {
            $("#sidebar").addClass("hide");
            $(".layui-body").addClass("sidebar-hidden");
            $(this).addClass("sidebar-hidden");
            $(this).find("i").removeClass("layui-icon-shrink-right").addClass("layui-icon-spread-left");
          } else {
            $("#sidebar").removeClass("hide");
            $(".layui-body").removeClass("sidebar-hidden");
            $(this).removeClass("sidebar-hidden");
            $(this).find("i").removeClass("layui-icon-spread-left").addClass("layui-icon-shrink-right");
          }
        });

        var currentWav = null; // 当前上传并转换后的 wav 文件名

        // 上传
        upload.render({
          elem: "#upload",
          field: "audio",
          accept: "file",
          exts: "mp4|mp3|flac|wav|aac|m4a|avi|mkv|mpeg|mov",
          multiple: false,
          url: "/upload",
          before: function () {
            currentWav = null;
            $("#uploaded-info").text("正在上传并转换为 wav，请稍候...");
            $("#audio-preview").html("");
          },
          done: function (res) {
            if (res.code !== 0) {
              layer.alert("上传失败：" + res.msg, { title: false });
              return;
            }
            currentWav = res.data;
            $("#uploaded-info").text("上传成功，已转换为 wav: " + currentWav);
            $("#audio-preview").html(
              '<audio src="/static/tmp/' +
                currentWav +
                '" controls style="width: 100%;"></audio>'
            );
          },
          error: function () {
            layer.alert("上传失败，请重试", { title: false });
          },
        });

        function buildTime(h, m, s) {
          function pad(v) {
            v = (v || "").trim();
            if (!v) return "00";
            if (!/^\d+$/.test(v)) return "00";
            if (v.length === 1) return "0" + v;
            return v.slice(-2);
          }
          return pad(h) + ":" + pad(m) + ":" + pad(s);
        }

        // 截取按钮
        $("#cut-btn").click(function () {
          if (!currentWav) {
            layer.alert("请先上传要截取的音频文件！", { title: false });
            return;
          }
          var startTime = buildTime(
            $("#start-h").val(),
            $("#start-m").val(),
            $("#start-s").val()
          );
          var endTime = buildTime(
            $("#end-h").val(),
            $("#end-m").val(),
            $("#end-s").val()
          );

          layer.load();
          $.post(
            "/cut_audio",
            {
              wav_name: currentWav,
              start_time: startTime,
              end_time: endTime,
            },
            function (res) {
              layer.closeAll("loading");
              if (res.code !== 0) {
                layer.alert("截取失败：" + res.msg, { title: false });
                return;
              }
              $("#cut-result").html(
                `截取成功：${res.file_name}&nbsp;&nbsp;<button type="button" class="layui-btn layui-btn-sm" onclick="window.open('${res.url}', '_blank')">下载</button>`
              );
              loadHistory();
            }
          ).fail(function () {
            layer.closeAll("loading");
            layer.alert("请求失败，请检查网络或后端服务", { title: false });
          });
        });

        function loadHistory() {
          $.get("/cut_history", function (res) {
            if (res.code !== 0) {
              return;
            }
            var tbody = $("#history-table tbody");
            tbody.empty();
            if (!res.data || !res.data.length) {
              tbody.append("<tr><td colspan='7'>暂无记录</td></tr>");
              return;
            }
            res.data.forEach(function (item, index) {
              var tr = `
                <tr>
                  <td>${item.id || (index + 1)}</td>
                  <td>${item.file_name}</td>
                  <td>${item.time_range || "00:00:00-00:00:00"}</td>
                  <td>${item.duration || "00:00:00"}</td>
                  <td>${item.size_mb !== undefined ? item.size_mb.toFixed(2) : ((item.size / (1024 * 1024)).toFixed(2))}</td>
                  <td>${item.mtime_str || ""}</td>
                  <td><button type="button" class="layui-btn layui-btn-sm" onclick="window.open('${item.url}', '_blank')">下载</button></td>
                </tr>
              `;
              tbody.append(tr);
            });
          });
        }

      // 页面加载时拉一次历史记录
      loadHistory();
    });
  </script>
        </div>
      </div>
    </div>
  </body>
</html>


