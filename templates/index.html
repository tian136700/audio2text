<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title data-cn="语音识别转文字" data-en="Speech Recognition to Text"></title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/static/layui/css/layui.css" rel="stylesheet" />
    <style>
      .preview-scroll {
        max-height: 450px;
        overflow: auto;
		color:#000;
      }
      .flex {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
        margin-left: 200px;
      }
      .flex-left {
        display: flex;
        align-items: center;
      }

      .my-1 {
        margin-top: 10px;
        margin-bottom: 10px;
      }

      .p-2 {
        padding: 15px;
      }

      .text-center {
        text-align: center;
      }

      .name {
        margin-right: 8px;
        width: 200px;
      }

      #upload {
        display: block;
        margin-bottom: 10px;
        border-style: solid;
        padding: 50px 30px;
      }

      .layui-form {
        margin: 15px auto;
      }

      .result-list {
        margin-top: 8px;
        margin-bottom: 8px;
        padding: 5px;
        border-bottom: 1px solid #f1f1f1;
      }

      .result-list .name {
        width: 150px;
        white-space: nowrap;
        text-overflow: ellipsis;
        text-align: left;
      }

      #content {
        width: 95%;
        min-width: 800px;
        max-width: 2000px;
        margin: 20px auto 50px;
      }
      .layui-side {
        width: 200px;
        top: 60px;
        transition: margin-left 0.3s;
      }
      .layui-side.hide {
        margin-left: -200px;
      }
      .layui-body {
        top: 60px;
        padding: 15px;
        transition: left 0.3s;
      }
      .layui-body.sidebar-hidden {
        left: 0 !important;
      }
      .sidebar-toggle {
        position: fixed;
        left: 200px;
        top: 60px;
        z-index: 1000;
        background: #393D49;
        color: #fff;
        border: none;
        padding: 10px 5px;
        cursor: pointer;
        border-radius: 0 4px 4px 0;
        transition: left 0.3s;
      }
      .sidebar-toggle:hover {
        background: #2F3437;
      }
      .sidebar-toggle.sidebar-hidden {
        left: 0;
      }

      .worktype {
        color: #999;
        font-size: 12px;
      }
      .text-res {
        margin-bottom: 15px;
      }
      .text-res-file {
        margin-bottom: 6px;
		font-size:18px;
		color:#000
      }
      .status {
        margin-left: 20px;
        width: 200px;
        white-space: break-spaces;
      }
      .progress-container {
        margin-left: 20px;
        width: 300px;
        display: none;
      }
      .progress-container.active {
        display: block;
      }
      .status-text {
        margin-top: 5px;
        font-size: 12px;
        color: #666;
      }
	  .d-flex, .d-flex > div{
		display:flex;
		align-items:center;
		justify-content:center
	  }
	  .layui-form-label{
		width:auto;
		padding:5px;
	  }
	  .layui-btn-disabled{
		background:#666 !important
	  }
    </style>
  </head>
  <body>
    <div class="layui-layout layui-layout-admin">
      <div class="layui-header" style="background: #16b777;z-index:1">
        <div
          class="layui-logo layui-hide-xs"
          style="color: #fff"
          data-en="STT {{ version }}"
          data-cn="语音识别 {{ version }}"
        ></div>
        <!-- 头部区域（可配合layui 已有的水平导航） -->
        <ul class="layui-nav layui-layout-right">
          <!-- 移动端显示 -->
          <li id="checkupdate" class="layui-nav-item layui-hide">
            <a
              href="https://github.com/jianchang512/sts/releases"
              class="layui-font-red"
              target="_blank"
            ></a>
          </li>
          <li class="layui-nav-item layui-hide-xs">
            <a href="https://github.com/jianchang512/sts" target="_blank"
              >Github</a
            >
          </li>
          <li class="layui-nav-item layui-hide-xs">
            <a
              href="https://github.com/jianchang512/sts/issue"
              target="_blank"
              data-en="Post Isue"
              data-cn="遇到问题?"
            ></a>
          </li>
          <li class="layui-nav-item layui-hide-xs">
            <a href="https://discord.gg/TMCM2PfHzQ" target="_blank">Discord</a>
          </li>
          <li class="layui-nav-item layui-hide-xs">
            <a
              href="https://github.com/jianchang512/sts/releases/tag/0.0"
              target="_blank"
              data-cn="下载模型"
              data-en="Download models"
            ></a>
          </li>
        </ul>
      </div>
      {% include 'includes/sidebar.html' %}
      <!-- 内容主体区域 -->
      <div class="layui-body">
      <div id="content">
        <!-- 内容主体区域 -->
        <div class="layui-upload-drag layui-border-green" id="upload">
          <i class="layui-icon layui-icon-upload layui-font-green"></i>
          <div
            data-cn="点击上传，或将音频视频文件拖拽到此处(wav,mp3,flac,mp4,mov,mkv,avi,mpeg)"
            data-en="click to upload or drag video or audio to here(wav,mp3,flac,mp4,mov,mkv,avi,mpeg)"
          ></div>
          <div class="layui-hide my-1" id="preview">
            <div class="preview-scroll"></div>
          </div>
        </div>
        <form class="layui-form text-center layui-form-pane">
		<div class="d-flex">
          <div class="layui-form-item">
            <label
              class="layui-form-label"
              
              data-cn="发音语言"
              data-en="Pronunciation Language"
            ></label>
            <div class="">
              <select name="language">
                {% for name,val in lang_code.items() %}
                <option value="{{ val[0] }}">{{ name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
		  <div class="layui-form-item">
            <label
              class="layui-form-label"
              
              data-cn="选择模型"
              data-en="Select model"
            ></label>
            <div class="">
              <select name="model">
                {% for name in model_list %}
                <option value="{{name}}">{{name}}</option>
				{% endfor %}			
				
              </select>
            </div>
          </div>
          <div class="layui-form-item">
            <label
              class="layui-form-label"
              
              data-cn="返回格式"
              data-en="Return format"
            ></label>
            <div class="">
              <select id="data_type" name="data_type">
                <option
                  value="srt"
                  data-cn="srt字幕"
                  data-en="Subtitles srt"
                ></option>
                <option value="readable" data-cn="易读格式（几分几秒）" data-en="Readable format (min:sec)"></option>
                <option value="json">json</option>
                <option value="text" data-cn="纯文字" data-en="text"></option>
              </select>
            </div>
          </div>

          <!-- 自动导出开关 -->
          <div class="layui-form-item">
            <label
              class="layui-form-label"
              
              data-cn="自动导出"
              data-en="Auto Export"
            ></label>
            <div class="">
              <select id="switch" name="switch">
                <option value="off" data-cn="关闭" data-en="OFF"></option>
                <option value="on" data-cn="开启" data-en="ON"></option>
              </select>
            </div>
          </div>

          <!-- 是否独立导出 -->
          <div class="layui-form-item">
            <label
              class="layui-form-label"
              
              data-cn="独立导出"
              data-en="Individual export"
            ></label>
            <div class="">
              <select id="isIndependent" name="isIndependent">
                <option value="on" data-cn="是" data-en="ON"></option>
                <option value="off" data-cn="否" data-en="OFF"></option>
              </select>
            </div>
          </div>

          <!-- 说话人识别 -->
          <div class="layui-form-item">
            <label
              class="layui-form-label"
              
              data-cn="说话人识别"
              data-en="Speaker Recognition"
            ></label>
            <div class="">
              <select id="enable_speaker" name="enable_speaker">
                <option value="off" data-cn="关闭" data-en="OFF"></option>
                <option value="on" data-cn="开启" data-en="ON"></option>
              </select>
            </div>
          </div>
	</div>
          <div
            class="layui-label-text layui-font-12 my-1 "
            data-en="The recognition of tiny to large-v3 models is becoming increasingly accurate, but it also consumes more resources. If you do not have the CUDA acceleration environment, do not choose large series models"
            data-cn="tiny到large-v3模型识别越来越精确，但也更消耗资源，如果不具备CUDA加速环境，请勿选用large系模型"
          ></div>
          

          <div class="layui-form-item layui-form-block">
            <input type="hidden" id="wav_name" name="wav_name" />
            <button
              type="button"
              class="layui-btn layui-btn-normal"
              data-cn="测试识别（前5分钟）"
              data-en="Test Recognition (First 5 min)"
              id="test-btn"
            >
              <i
                style="display: none"
                class="layui-icon-loading layui-icon layui-anim layui-anim-rotate layui-anim-loop"
              ></i>
            </button>
            <button
              type="submit"
              class="layui-btn layui-btn-danger"
              lay-submit
              lay-filter="submit"
              data-cn="立即识别（{{ devtype.upper()}}）"
              data-en="Start Separate ({{ devtype.upper()}})"
              id="submit-btn"
            >
              <i
                style="display: none"
                class="layui-icon-loading layui-icon layui-anim layui-anim-rotate layui-anim-loop"
              ></i>
            </button>
            <div
              class="layui-btn layui-btn-disabled"
              data-cn="导出文本"
              data-en="Export Text"
              id="export-btn"
            ></div>
          </div>
        </form>
		

        <!-- 测试结果显示区域 -->
        <div class="layui-card layui-hide" id="test-result-card" style="margin-bottom: 15px;">
          <div class="layui-card-header">
            <span data-cn="测试识别结果（前5分钟）" data-en="Test Recognition Result (First 5 min)"></span>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="confirm-test-btn" style="float: right; margin-top: -5px;" data-cn="确认，继续完整识别" data-en="Confirm, Continue Full Recognition"></button>
          </div>
          <div class="layui-card-body" style="padding: 10px 0">
            <textarea
              class="layui-textarea"
              id="test-result"
              readonly
              cols="30"
              rows="8"
            ></textarea>
          </div>
        </div>

        <div class="layui-card">
          <div class="layui-card-body text-contain" style="padding: 10px 0">
            <textarea
              placeholder-cn="识别结果在此显示"
              placeholder-en="Result list in here"
              class="layui-textarea"
              id="result"
              readonly
              cols="30"
              rows="10"
            ></textarea>
          </div>
        </div>
      </div>
    </div>
	
	<div style="text-align:center">
		<a data-cn="点击查看如何添加huggingface.co上的模型" data-en="Click to see how to add models on huggingface.co" style="text-align:center;font-size:12px;color:#777" href="https://pyvideotrans.com/stthuggingface" target="_blank"></a>
	</div>

    <script src="/static/layui/layui.js"></script>
    <script>
      let language = "zh"; // 强制使用中文
      window.$ = layui.$;
      let intervalId = null;
      // 强制显示中文
      $("[data-cn]").each(function () {
        var $this = $(this);
        var text = $this.attr("data-cn");
        // 如果是菜单项，填充到 .menu-text 中
        var $menuText = $this.find(".menu-text");
        if ($menuText.length) {
          $menuText.text(text);
        } else {
          // 其他元素，追加文字
          $this.html($this.html() + text);
        }
      });
      $("[placeholder-cn]").each(function () {
        $(this).attr("placeholder", $(this).attr("placeholder-cn"));
      });
      /** 即将要处理的文件信息 */
      var pending_files = [];

      var processing = false;
      function get_file_el(file_name) {
        return $(`.flex[name="${file_name}"]`);
      }
      function set_status(file_name, status, color) {
        var file_element = get_file_el(file_name);
        var status_element = file_element.find(".status");
        var progress_container = file_element.find(`#progress-${file_name.replace(/\./g, '-')}`);
        var status_text = file_element.find(`#status-text-${file_name.replace(/\./g, '-')}`);
        
        // 如果状态是百分比格式（如 "50%" 或 "50.00%"），显示进度条
        var percentageMatch = status.match(/(\d+\.?\d*)%/);
        if (percentageMatch) {
          var percentage = parseFloat(percentageMatch[1]);
          // 显示进度条
          progress_container.addClass("active");
          status_element.hide();
          // 更新进度条
          if (typeof layui !== 'undefined' && layui.element) {
            var filter = `progress-${file_name.replace(/\./g, '-')}`;
            layui.element.progress(filter, percentage + "%");
          }
          // 更新状态文字
          status_text.text(status).css("color", color);
        } else {
          // 非百分比状态，显示文字状态
          progress_container.removeClass("active");
          status_element.html(status).show().css("color", color);
          status_text.text("");
        }
      }

      var getprogress = function (file_name, field, star_time) {
        var file_element = get_file_el(file_name);
        var done = null;
        var handler = function () {
          $.post("/progressbar", field, function (res) {
            if (res.code !== 0) {
              done({
                error: res.msg,
                file_name,
              });
              set_status(file_name, res.msg, "#ff5722");
			  return
            }
            const percentage = `${(res["data"] * 100).toFixed(2)}%`;
            set_status(file_name, percentage, "#16b777");
            if (res["data"] >= 1) {
              var sec = +new Date() - star_time;
              // 100% 完成时，更新进度条到100%，并显示完成信息
              var file_element = get_file_el(file_name);
              var progress_container = file_element.find(`#progress-${file_name.replace(/\./g, '-')}`);
              var status_text = file_element.find(`#status-text-${file_name.replace(/\./g, '-')}`);
              
              // 确保进度条显示并更新到100%
              if (typeof layui !== 'undefined' && layui.element) {
                var filter = `progress-${file_name.replace(/\./g, '-')}`;
                layui.element.progress(filter, "100%");
              }
              progress_container.addClass("active");
              status_text.text(`100%     ${(sec / 1000).toFixed(2)} sec`).css("color", "#16b777");
              file_element.find(".status").hide();
              if (done) {
                done({
                  res,
                  file_name,
                });
              }
              return;
            }
            setTimeout(() => {
              handler();
            }, 500);
          }).fail(function () {
            setTimeout(() => {
              handler();
            }, 500);
          });
        };
        handler();
        return {
          done: function (cb) {
            done = cb;
          },
        };
      };

      function process(file, field) {
        return new Promise(function (resolve) {
          set_status(file.data, "0%", "#16b777");

			$.ajax({
				url:"/process", 
				method:"POST",
				data:field, 
				timeout:8640000000,
				success:function (res) {
					if (res.code !== 0) {
					  resolve({
						error: res.msg,
						file_name: file.data,
					  });
					  set_status(file.data, res.msg, "#ff5722");
					  return;
					}
					getprogress(file.data, field, +new Date()).done(function (res) {
					  resolve(res);
					});
				},
				error:function (msg) {
					set_status(file.data, msg.statusText, "#ff5722");
					resolve({
					  error: msg.statusText,
					  file_name: file.data,
					});
				}
			});
        });
      }

      function process_loading() {
        return {
          start: function () {
            processing = true;
            $("#submit-btn").addClass("layui-btn-disabled").find("i").show();
          },
          end: function () {
            processing = false;
            $("#submit-btn").removeClass("layui-btn-disabled").find("i").hide();
          },
        };
      }

      //JS
      layui.use(function () {
        var element = layui.element;
        var layer = layui.layer;
        
        // 渲染进度条组件
        element.render('progress');
        
        // 侧边栏隐藏/显示功能
        var sidebarHidden = false;
        $("#sidebar-toggle").click(function() {
          sidebarHidden = !sidebarHidden;
          if (sidebarHidden) {
            $("#sidebar").addClass("hide");
            $(".layui-body").addClass("sidebar-hidden");
            $(this).addClass("sidebar-hidden");
            $(this).find("i").removeClass("layui-icon-shrink-right").addClass("layui-icon-spread-left");
          } else {
            $("#sidebar").removeClass("hide");
            $(".layui-body").removeClass("sidebar-hidden");
            $(this).removeClass("sidebar-hidden");
            $(this).find("i").removeClass("layui-icon-spread-left").addClass("layui-icon-shrink-right");
          }
        });

        var upload = layui.upload;
        let form = layui.form;
        // 渲染
        let layindex1 = null;
        upload.render({
          elem: "#upload",
          field: "audio",
          accept: "file",
          exts: "mp4|mp3|flac|wav|aac|m4a|avi|mkv|mpeg|mov",
          multiple: true,
          url: "/upload", // 实际使用时改成您自己的上传接口即可。
          choose: function () {
            pending_files = [];
          },
          before: function () {
            if (processing) {
              return false;
            }
			
			layindex1=layer.load();
          },
          done: function (res) {
            pending_files.push(res);
            //$('#wav_name').val(res.data);
            console.log(res);
          },
          allDone: function () {
			layer.close(layindex1);
            // 清空预览区域
            var $preview = $("#preview");
            var $previewScroll = $("<div>").addClass("preview-scroll");
            
            // 使用 jQuery 创建每个文件元素
            $.each(pending_files, function(index, file) {
              var progressId = "progress-" + file.data.replace(/\./g, '-');
              var filter = "progress-" + file.data.replace(/\./g, '-');
              
              var $flex = $("<div>").addClass("flex").attr("name", file.data);
              $flex.append($("<span>").addClass("name").text(file.msg + " " + (file.data || "")));
              $flex.append($("<audio>").attr("src", "/static/tmp/" + file.data).attr("controls", true));
              $flex.append($("<div>").addClass("status"));
              
              var $progressContainer = $("<div>").addClass("progress-container").attr("id", progressId);
              var $progress = $("<div>").addClass("layui-progress")
                .attr("lay-showpercent", "true")
                .attr("lay-filter", filter);
              $progress.append($("<div>").addClass("layui-progress-bar").attr("lay-percent", "0%"));
              $progressContainer.append($progress);
              $progressContainer.append($("<div>").addClass("status-text").attr("id", "status-text-" + file.data.replace(/\./g, '-')));
              
              $flex.append($progressContainer);
              $previewScroll.append($flex);
            });
            
            $preview.empty().append($("<hr>")).append($previewScroll).removeClass("layui-hide");
            
            // 重新渲染进度条
            if (typeof layui !== 'undefined' && layui.element) {
              layui.element.render('progress');
            }
            
			layer.msg(language === "zh" ? '上传完成，可以点击开始识别了' : 'The upload is complete and you can click on Start Recognizing');
          },
        });
        // 导出
        function exportText(title, text) {
            var file_type = $("#data_type").val();
            var file_name = title.replace('wav', file_type.replace('text','txt'))
            var blob = new Blob([text], {
              type: "text/plain",
            });
            var url = URL.createObjectURL(blob);
            var aEl = document.createElement("a");
            aEl.href = url;
            aEl.target = "_blank";
            aEl.download = file_name;
            aEl.click();
            aEl.remove();
            URL.revokeObjectURL(url);
          }
        // 手动导出
        $("#export-btn").click(function () {
          if ($(this).hasClass("layui-btn-disabled")) {
            return;
          }
          var textElList = $(".text-res");
          if (!textElList.length) {
            layer.alert(
              language === "zh"
                ? "请先识别后再进行导出!"
                : "Please process first before exporting!",
              { title: false }
            );
            return;
          }
          // 是否独立导出
          if($("#isIndependent").val() === 'on') {
            var file_type = $("#data_type").val();
            [...textElList].forEach((el) => {
              var title = $(el).find(".text-res-file").text();
              var text = $(el).find("textarea").val();
              exportText(title, text)
            });
          }else {
            var exportInfos = [...textElList]
            .map(function (el) {
              var info = {
                title: $(el).find(".text-res-file").text(),
                text: $(el).find("textarea").val(),
              };
              return `${info.text}`;
            })
            .join("\n\n\n");
            var blob = new Blob([exportInfos], {
              type: 'text/plain'
            })
            var url = URL.createObjectURL(blob)
            var aEl = document.createElement('a')
            aEl.href = url
            aEl.target = '_blank'
            aEl.download = '全部音频文本.txt'
            aEl.click()
            aEl.remove()
            URL.revokeObjectURL(url)
          }

          
        });
        
        // 测试识别按钮
        $("#test-btn").click(function () {
          if (processing) {
            return;
          }
          if (!pending_files.length) {
            layer.alert(
              language === "zh"
                ? "必须先上传要识别的音频或视频文件!"
                : "The file to be recognition must be uploaded first!",
              { title: false }
            );
            return;
          }
          
          var field = {
            model: $("select[name='model']").val(),
            language: $("select[name='language']").val(),
            data_type: $("#data_type").val(),
            enable_speaker: $("#enable_speaker").val()
          };
          
          if(field['model'].endsWith('.en') && field['language']!='en'){
            layer.alert(
              language === "zh"
                ? "en结尾的模型只可用于确定的英语语音识别!"
                : "Models ending in en can only be used for English speech recognition!",
              { title: false }
            );
            return;
          }
          
          // 只测试第一个文件
          var testFile = pending_files[0];
          if (!testFile || !testFile.data) {
            layer.alert(
              language === "zh"
                ? "没有可测试的文件!"
                : "No file to test!",
              { title: false }
            );
            return;
          }
          
          // 显示加载状态
          processing = true;
          $("#test-btn").addClass("layui-btn-disabled").find("i").show();
          $("#test-result-card").addClass("layui-hide");
          
          // 发送测试请求
          $.ajax({
            url: "/test_process",
            method: "POST",
            data: {
              wav_name: testFile.data,
              model: field.model,
              language: field.language,
              data_type: field.data_type,
              enable_speaker: field.enable_speaker
            },
            success: function (res) {
              processing = false;
              $("#test-btn").removeClass("layui-btn-disabled").find("i").hide();
              
              if (res.code !== 0) {
                layer.alert(
                  language === "zh"
                    ? "测试识别失败: " + res.msg
                    : "Test recognition failed: " + res.msg,
                  { title: false }
                );
                return;
              }
              
              // 检查是否启用了说话人识别但没有结果
              if (field.enable_speaker === 'on' && res.result && !res.result.includes('说话人')) {
                layer.msg(
                  language === "zh"
                    ? "提示：已开启说话人识别，但未检测到说话人信息。请确保已安装 pyannote.audio (pip install pyannote.audio)"
                    : "Note: Speaker recognition is enabled but no speaker info detected. Please ensure pyannote.audio is installed.",
                  { time: 5000 }
                );
              }
              
              // 显示测试结果
              function getText(res) {
                try {
                  if (typeof res === "string") {
                    return res;
                  }
                  return JSON.stringify(res);
                } catch (e) {
                  return res;
                }
              }
              
              $("#test-result").val(getText(res.result));
              $("#test-result-card").removeClass("layui-hide");
              
              var duration = res.duration || 0;
              layer.msg(
                language === "zh"
                  ? `测试识别完成！已识别 ${duration.toFixed(2)} 秒音频`
                  : `Test recognition completed! Recognized ${duration.toFixed(2)} seconds of audio`
              );
            },
            error: function (xhr, status, error) {
              processing = false;
              $("#test-btn").removeClass("layui-btn-disabled").find("i").hide();
              layer.alert(
                language === "zh"
                  ? "测试识别失败: " + error
                  : "Test recognition failed: " + error,
                { title: false }
              );
            }
          });
        });
        
        // 确认继续完整识别
        $("#confirm-test-btn").click(function () {
          // 隐藏测试结果
          $("#test-result-card").addClass("layui-hide");
          // 触发完整识别
          $("#submit-btn").click();
        });
        
        // 提交事件
        form.on("submit(submit)", function (data) {
          console.log('submit', data)
          if (processing) {
            return;
          }
          var field = data.field; // 获取表单全部字段值
          if (!pending_files.length) {
            layer.alert(
              language === "zh"
                ? "必须先上传要识别的音频或视频文件!"
                : "The file to be recognition must be uploaded first!",
              { title: false }
            );
            return false;
          }
		  if(field['model'].endsWith('.en') && field['language']!='en'){
			layer.alert(
              language === "zh"
                ? "en结尾的模型只可用于确定的英语语音识别!"
                : "Models ending in en can only be used for English speech recognition!",
              { title: false }
            );
            return false;
		  }
		  
		  
		  
          // 开始识别
          process_loading().start();
          // 按钮禁用
          $("#export-btn").addClass("layui-btn-disabled");
          $(".text-contain").html(`
          <textarea
              placeholder="${
                language === "zh" ? "识别结果在此显示" : "Result list in here"
              }"
              class="layui-textarea res-placeholder"
              id="result"
              readonly
              cols="30"
              rows="10"
            ></textarea>
          `);
          function getText(res) {
            try {
              if (typeof res === "string") {
                return res;
              }
              return JSON.stringify(res);
            } catch (e) {
              return res;
            }
          }
          // 批量处理文件
          Promise.allSettled(
            pending_files.map(function (file) {
              return process(file, {
                ...field,
                wav_name: file.data,
              }).then(function (res) {
                // 识别结果文本区域以及导出避免误操作
                $(".res-placeholder").hide();
                $("#export-btn").removeClass("layui-btn-disabled");
                // 文件名显示
                var texts_el = document.createElement("div");
                texts_el.className = "text-res";
                $(texts_el).html(
                  `<div class="text-res-file">${res.file_name}</div>
                    <textarea
                        name="${res.file_name}"
                        class="layui-textarea"
                        cols="30"
                        rows="10"
                    ></textarea>`
                );
                $(".text-contain").append(texts_el);
                $(texts_el).find("textarea").val(getText(res.res.result));
                // 自动导出
                if (field.switch === "on") {
                  exportText(res.file_name, getText(res.res.result))
                }
              });
            })
          ).finally(function () {
            // 识别按钮解禁
            process_loading().end();
          });
          return false; // 阻止默认 form 跳转
        });
        setTimeout(() => {
          $.get("/checkupdate", function (res) {
            if (res.code === 0 && res.msg) {
              $("#checkupdate").removeClass("layui-hide");
              $("#checkupdate a").text(res.msg);
            }
          });
        }, 60000);
      });

	
	
    </script>
        </div>
      </div>
    </div>
  </body>
</html>
